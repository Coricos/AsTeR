{%  extends 'dashboard/dashboard_summary.html' %}

{%  block map_block %}

    <script>
        var map_parameters = JSON.parse('{{map_parameters|tojson|safe}}');
        var map;
        var earthquakeMap;

        // Initialize and add the map
        function initMap() {

            //////////////////////////  Map styles  ///////////////////

            map_options = {
                zoom: map_parameters.zoom,
                center: {lat: map_parameters.lat, lng: map_parameters.lng},
                mapTypeId: map_parameters.mapType,
                streetViewControl: map_parameters.streetview_control,
                fullscreenControl: map_parameters.fullscreen_control,
                {#mapTypeControlOptions: {#}
                {#    mapTypeIds: ['roadmap','terrain']#}
                {# },#}
                mapTypeControl: false
            };

            {# Normal day mode #}
            map = new google.maps.Map(document.getElementById(map_parameters.identifier), map_options);

            if (map_parameters.night_mode) {

                {# Night mode #}
                var nightMapType = new google.maps.StyledMapType(
                    [
                        {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
                        {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
                        {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
                        {
                            featureType: 'administrative.locality',
                            elementType: 'labels.text.fill',
                            stylers: [{color: '#d59563'}]
                        },
                        {
                            featureType: 'poi',
                            elementType: 'labels.text.fill',
                            stylers: [{color: '#d59563'}]
                        },
                        {
                            featureType: 'poi.park',
                            elementType: 'geometry',
                            stylers: [{color: '#263c3f'}]
                        },
                        {
                            featureType: 'poi.park',
                            elementType: 'labels.text.fill',
                            stylers: [{color: '#6b9a76'}]
                        },
                        {
                            featureType: 'road',
                            elementType: 'geometry',
                            stylers: [{color: '#38414e'}]
                        },
                        {
                            featureType: 'road',
                            elementType: 'geometry.stroke',
                            stylers: [{color: '#212a37'}]
                        },
                        {
                            featureType: 'road',
                            elementType: 'labels.text.fill',
                            stylers: [{color: '#9ca5b3'}]
                        },
                        {
                            featureType: 'road.highway',
                            elementType: 'geometry',
                            stylers: [{color: '#746855'}]
                        },
                        {
                            featureType: 'road.highway',
                            elementType: 'geometry.stroke',
                            stylers: [{color: '#1f2835'}]
                        },
                        {
                            featureType: 'road.highway',
                            elementType: 'labels.text.fill',
                            stylers: [{color: '#f3d19c'}]
                        },
                        {
                            featureType: 'transit',
                            elementType: 'geometry',
                            stylers: [{color: '#2f3948'}]
                        },
                        {
                            featureType: 'transit.station',
                            elementType: 'labels.text.fill',
                            stylers: [{color: '#d59563'}]
                        },
                        {
                            featureType: 'water',
                            elementType: 'geometry',
                            stylers: [{color: '#17263c'}]
                        },
                        {
                            featureType: 'water',
                            elementType: 'labels.text.fill',
                            stylers: [{color: '#515c6d'}]
                        },
                        {
                            featureType: 'water',
                            elementType: 'labels.text.stroke',
                            stylers: [{color: '#17263c'}]
                        }
                    ],
                    {name: 'Night mode'});

                map_options.mapTypeControlOptions = { mapTypeIds: ['roadmap','terrain','night_map']};
                map.setOptions(map_options);

                //Associate the night mode map with the MapTypeId and set it to display.
                map.mapTypes.set('night_map', nightMapType);
            }

            //////////////////////////  Markers  ///////////////////

            // Defines the icon parameters (circles)
            function set_icon_parameters(color) {
                var icon_parameters = {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillOpacity: 0.8,
                    strokeOpacity: 0.8,
                    strokeWeight: 0.8
                };
                icon_parameters.fillColor = color;
                {#icon_parameters.strokeColor: color,#}
                return icon_parameters
            }

            const icons = {
                police: {
                    name: 'Police Unit',
                    icon: set_icon_parameters('#484ed5')
                },
                ambulance: {
                    name: 'Ambulance',
                    icon: set_icon_parameters('#d51f13')
                },
                firefighter: {
                    name: 'Firefighter',
                    icon: set_icon_parameters('#d57600')
                }
            }; // Creates the icons array.

            // Create the markers array.
            var dispatched_units = [];
            var all_markers = [];
            for (i=0; i < map_parameters.units.length; i++) {
                var unit = map_parameters.units[i];
                dispatched_units.push({
                    position: new google.maps.LatLng(unit.latitude, unit.longitude),
                    type: unit.unit_type,
                    name: unit.name,
                    content: '<div id="content"><div id="siteNotice"></div>'+
                        '<h5 id="firstHeading" class="firstHeading">'+unit.name+'</h5>'+
                        '<div id="bodyContent"><p><b>Unit ID: </b>'+unit.id+'</p>' +
                        '<p>'+unit.infobox+'</p></div></div>'
                });
            }

            var currentinfowindow = null; // To keep only one window open (see below in add listener)

            // Put the markers on the map.
            dispatched_units.forEach(function(unit) {
                var marker = new google.maps.Marker({
                    position: unit.position,
                    title: unit.name,
                    icon: icons[unit.type].icon,
                    map: map
                });
                all_markers.push(marker);
                var content = unit.content;
                var infowindow = new google.maps.InfoWindow();
                marker.addListener('click', (function() {
                    return function () {
                        infowindow.setContent(content);
                        if (currentinfowindow)
                            currentinfowindow.close();
                        infowindow.open(map, marker);
                        currentinfowindow = infowindow;
                    };
                })(marker, content, infowindow));

                // To have the infowindow displayed during mouseover only. Nice now but might not be practical
                // when the markers are moving!
                if (map_parameters.info_on_mouseover) {
                    marker.addListener('mouseover', (function() {
                        return function () {
                            infowindow.setContent(content);
                            infowindow.open(map, marker);
                        };
                    })(marker, content, infowindow));

                    marker.addListener('mouseout', (function() {
                        return function () {
                            infowindow.close();
                        };
                    })(infowindow));
                }
            });

            //////////////////////////  Legend ///////////////////

            // Create the legend
            var legend = document.getElementById('legend');
            for (var key in icons) {
                var type = icons[key];
                var name = type.name;
                var color = type.icon.fillColor;
                var div = document.createElement('div');
                div.innerHTML = '<svg height="20" width="20"><circle cx="10" cy="10" r="7.5" stroke="black" stroke-width="1" fill="'+color+'"/></svg><b>' + name + '</b>';
                legend.appendChild(div);
            }

            // Add the legend on the map
            map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend);

            //////////////////////////  Djikstra Paths ///////////////////

            for (var i=0;i < map_parameters.djikstra_path.length;i++) {
                var path_information = map_parameters.djikstra_path[i];
                var djikstraPath = new google.maps.Polyline({
                    path: path_information.coordinates,
                    geodesic: true,
                    strokeColor: icons[path_information.type].icon.fillColor,
                    strokeOpacity: 0.8,
                    strokeWeight: 3
                });
                djikstraPath.setMap(map);
            }

            //////////////////////////  Earthquake information ///////////////////


            // Get the earthquake data (JSONP format)
            // Source: http://earthquake.usgs.gov/earthquakes/feed/v1.0/geojson.php
            earthquakeMap = new google.maps.Data( {} );
            {#earthquakeMap.loadGeoJson('https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=2019-07-11&minmagnitude=4&latitude='+map_parameters.lat+'&longitude='+map_parameters.lng+'&maxradiuskm=500')#}
            loadEarthquakes(earthquakeMap);
            earthquakeMap.setStyle(styleEarthquake);
            earthquakeMap.setMap(map);

            // To do: take as input radius and user's location.
            function loadEarthquakes(map){

                // Load the GeoJSON
                $.getJSON('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojson', function (data) {

                    var features = data.features;
                    var next_to_user = [];

                    const max_lat = 48.5721;
                    const min_lat = 23.9821;
                    const min_lng = - 128.7768;
                    const max_lng = -77.6569;

                    for (var i = 0; i < features.length; i++) {
                        var lat = features[i].geometry.coordinates[1];
                        var lng = features[i].geometry.coordinates[0];
                        if (min_lat<lat && lat<max_lat && min_lng<lng && lng<max_lng)
                            next_to_user.push(features[i])
                    }
                    data.features = next_to_user;
                    map.addGeoJson(data)
                });
            }

            //////////////////////////  Center on user  ///////////////////

            // Allow the map to be centered on the user's location
            if (map_parameters.center_on_user_location) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(pos);
                    }, function() {
                        handleLocationError(true, infoWindow, map.getCenter());
                    });
                }
                else {
                    // Browser doesn't support Geolocation
                    handleLocationError(false, infoWindow, map.getCenter());
                }
            }

            //////////////////////////  Fit window to all markers  ///////////////////
            {% if map_parameters.fit_markers_to_bounds %}
                // fit all markers in bounds
                var map_bounds = new google.maps.LatLngBounds();
                for(i=0; i<all_markers.length;i++) {
                    map_bounds.extend(all_markers[i].getPosition());
                }
                map.fitBounds(map_bounds);
            {% endif %}
        }

        // Defines the callback function referenced in the jsonp file.
        function eqfeed_callback(data) {
            map.data.addGeoJson(data);
        }

        function toggleEarthquakes() {
            earthquakeMap.setMap(earthquakeMap.getMap() ? null : map);
        }

        function styleEarthquake(feature) {
            var magnitude = feature.getProperty('mag');
            return {
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    strokeWeight: 0.5,
                    strokeColor: '#fff',
                    fillColor: 'red', // future update: change the color to alert level.
                    fillOpacity: 2 / magnitude,
                    scale: Math.pow(2, magnitude) / 2
                },
                zIndex: Math.floor(feature.getProperty('mag'))
            };
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
            infoWindow.open(map);
        }
    </script>

{% endblock %}