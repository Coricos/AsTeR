{%  extends 'layout.html' %}

{%  block body %}

    <link href="/static/dashboard.css" rel="stylesheet">

    <main role="main" class="p-1 pl-3 ml-sm-auto px-4">
        <div class="cover-container" style="text-align: left">
            <h1>Welcome to your dashboard, {{ session.username }}!</h1>
        </div>
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <p class="lead">Here is a short description of the dashboard and some stats.</p>
        </div>

        <div class="row">
            <div class="col-lg-8" id={{ map_parameters.identifier }}>
                {#                {% block map_block %}{% endblock %}#}

                <script>
                    var map_parameters = JSON.parse('{{map_parameters | tojson}}');

                    {##}
                    {#function setMarkers(map) {#}
                    {#    for (var i=0; i < map_parameters.markers.length; i++) {#}
                    {#        var indiv_marker = map_parameters.markers[i];#}
                    {#        var marker = new google.maps.Marker({#}
                    {#            position: {lat:indiv_marker.lat, lng:indiv_marker.lng},#}
                    {#            icon: {#}
                    {#                path: google.maps.SymbolPath.CIRCLE,#}
                    {#                scale: 7,#}
                    {#                fillColor: indiv_marker.icon_color,#}
                    {#strokeColor: indiv_marker.icon_color,#}
                    {#                fillOpacity: 0.8,#}
                    {#                strokeOpacity: 0.8,#}
                    {#                strokeWeight: 0.8#}
                    {#            },#}
                    {#            map: map#}
                    {#        });#}
                    {#    }#}
                    {# }#}

                    // Initialize and add the map
                    function initMap() {

                        {# Night mode #}
                        var nightMapType = new google.maps.StyledMapType(
                            [
                                {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
                                {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
                                {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
                                {
                                    featureType: 'administrative.locality',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#d59563'}]
                                },
                                {
                                    featureType: 'poi',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#d59563'}]
                                },
                                {
                                    featureType: 'poi.park',
                                    elementType: 'geometry',
                                    stylers: [{color: '#263c3f'}]
                                },
                                {
                                    featureType: 'poi.park',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#6b9a76'}]
                                },
                                {
                                    featureType: 'road',
                                    elementType: 'geometry',
                                    stylers: [{color: '#38414e'}]
                                },
                                {
                                    featureType: 'road',
                                    elementType: 'geometry.stroke',
                                    stylers: [{color: '#212a37'}]
                                },
                                {
                                    featureType: 'road',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#9ca5b3'}]
                                },
                                {
                                    featureType: 'road.highway',
                                    elementType: 'geometry',
                                    stylers: [{color: '#746855'}]
                                },
                                {
                                    featureType: 'road.highway',
                                    elementType: 'geometry.stroke',
                                    stylers: [{color: '#1f2835'}]
                                },
                                {
                                    featureType: 'road.highway',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#f3d19c'}]
                                },
                                {
                                    featureType: 'transit',
                                    elementType: 'geometry',
                                    stylers: [{color: '#2f3948'}]
                                },
                                {
                                    featureType: 'transit.station',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#d59563'}]
                                },
                                {
                                    featureType: 'water',
                                    elementType: 'geometry',
                                    stylers: [{color: '#17263c'}]
                                },
                                {
                                    featureType: 'water',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#515c6d'}]
                                },
                                {
                                    featureType: 'water',
                                    elementType: 'labels.text.stroke',
                                    stylers: [{color: '#17263c'}]
                                }
                            ],
                            {name: 'Night mode'});

                        {# Normal day mode #}
                        var map = new google.maps.Map(
                            document.getElementById(map_parameters.identifier), {
                                zoom: map_parameters.zoom,
                                center: {lat: map_parameters.lat, lng: map_parameters.lng},
                                mapTypeId: map_parameters.maptype,
                                streetViewControl: false,
                                fullscreenControl: false,
                                mapTypeControlOptions: {
                                    mapTypeIds: ['terrain','night_map']
                                }
                            });

                        //Associate the night mode map with the MapTypeId and set it to display.
                        map.mapTypes.set('night_map', nightMapType);

                        // Sets all the markers on the app
                        {#setMarkers(map);#}

                        // Create the icons array.
                        var icons = {
                            police: {
                                name: 'Police Unit',
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 7,
                                    fillColor: '#484ed5',
                                    {#strokeColor: indiv_marker.icon_color,#}
                                    fillOpacity: 0.8,
                                    strokeOpacity: 0.8,
                                    strokeWeight: 0.8
                                }
                            },
                            ambulance: {
                                name: 'Ambulance',
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 7,
                                    fillColor: '#d51f13',
                                    {#strokeColor: indiv_marker.icon_color,#}
                                    fillOpacity: 0.8,
                                    strokeOpacity: 0.8,
                                    strokeWeight: 0.8
                                }
                            },
                            firefighter: {
                                name: 'Firefighter Unit',
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 7,
                                    fillColor: '#d57600',
                                    {#strokeColor: indiv_marker.icon_color,#}
                                    fillOpacity: 0.8,
                                    strokeOpacity: 0.8,
                                    strokeWeight: 0.8
                                }
                            }
                        };

                        // Create the features (markers) array.
                        var features = [];
                        for (var i=0; i < map_parameters.units.length; i++) {
                            var unit = map_parameters.units[i];
                            features.push({
                                position: new google.maps.LatLng(unit.lat, unit.lng),
                                type: unit.type
                                // Add the other parameters
                            });
                        }

                        // Create markers.
                        features.forEach(function(feature) {
                            var marker = new google.maps.Marker({
                                position: feature.position,
                                icon: icons[feature.type].icon,
                                map: map
                            });
                        });

                        // Create the legend
                        var legend = document.getElementById('legend');
                        for (var key in icons) {
                            var type = icons[key];
                            var name = type.name;
                            var color = type.icon.fillColor;
                            var div = document.createElement('div');
                            div.innerHTML = '<svg height="20" width="20"><circle cx="10" cy="10" r="7.5" stroke="black" stroke-width="1" fill="'+color+'"/></svg><b>' + name + '</b>';
                            legend.appendChild(div);
                        }

                        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend);

                        if (map_parameters.center_on_user_location) {
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(function(position) {
                                    var pos = {
                                        lat: position.coords.latitude,
                                        lng: position.coords.longitude
                                    };
                                    map.setCenter(pos);
                                }, function() {
                                    handleLocationError(true, infoWindow, map.getCenter());
                                });
                            }
                            else {
                                // Browser doesn't support Geolocation
                                handleLocationError(false, infoWindow, map.getCenter());
                            }
                        }
                    }

                    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                        infoWindow.setPosition(pos);
                        infoWindow.setContent(browserHasGeolocation ?
                            'Error: The Geolocation service failed.' :
                            'Error: Your browser doesn\'t support geolocation.');
                        infoWindow.open(map);
                    }
                </script>
            </div>
            <div id="legend"><h3>Legend</h3></div>
            <div class="col-lg-4 id="calls>
                <p> Some calls are displayed here. </p>
            </div>
        </div>

        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 border-bottom"></div>
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <p class="lead"><b>Here are some statistics about recent calls.</b></p>
        </div>
    </main>

{% endblock %}