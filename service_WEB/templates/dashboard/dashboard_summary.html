{%  extends 'layout.html' %}

{%  block body %}

    <link href="/static/dashboard.css" rel="stylesheet">

    <main role="main" class="p-1 pl-3 ml-sm-auto px-4">
        <div class="cover-container" style="text-align: left">
            <h1>Welcome to your dashboard, {{ session.username }}!</h1>
        </div>
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <p class="lead">Here is a short description of the dashboard and some stats.</p>
        </div>

        <div class="row">
            <div class="col-lg-10" >
                <div id={{ map_parameters.identifier }}>
{#                    {% block map_block %}{% endblock %}#}
                <script>
                    var map_parameters = JSON.parse('{{map_parameters | tojson}}');

                    // Initialize and add the map
                    function initMap() {

                        //////////////////////////  Map styles  ///////////////////

                        {# Night mode #}
                        var nightMapType = new google.maps.StyledMapType(
                            [
                                {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
                                {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
                                {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
                                {
                                    featureType: 'administrative.locality',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#d59563'}]
                                },
                                {
                                    featureType: 'poi',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#d59563'}]
                                },
                                {
                                    featureType: 'poi.park',
                                    elementType: 'geometry',
                                    stylers: [{color: '#263c3f'}]
                                },
                                {
                                    featureType: 'poi.park',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#6b9a76'}]
                                },
                                {
                                    featureType: 'road',
                                    elementType: 'geometry',
                                    stylers: [{color: '#38414e'}]
                                },
                                {
                                    featureType: 'road',
                                    elementType: 'geometry.stroke',
                                    stylers: [{color: '#212a37'}]
                                },
                                {
                                    featureType: 'road',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#9ca5b3'}]
                                },
                                {
                                    featureType: 'road.highway',
                                    elementType: 'geometry',
                                    stylers: [{color: '#746855'}]
                                },
                                {
                                    featureType: 'road.highway',
                                    elementType: 'geometry.stroke',
                                    stylers: [{color: '#1f2835'}]
                                },
                                {
                                    featureType: 'road.highway',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#f3d19c'}]
                                },
                                {
                                    featureType: 'transit',
                                    elementType: 'geometry',
                                    stylers: [{color: '#2f3948'}]
                                },
                                {
                                    featureType: 'transit.station',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#d59563'}]
                                },
                                {
                                    featureType: 'water',
                                    elementType: 'geometry',
                                    stylers: [{color: '#17263c'}]
                                },
                                {
                                    featureType: 'water',
                                    elementType: 'labels.text.fill',
                                    stylers: [{color: '#515c6d'}]
                                },
                                {
                                    featureType: 'water',
                                    elementType: 'labels.text.stroke',
                                    stylers: [{color: '#17263c'}]
                                }
                            ],
                            {name: 'Night mode'});

                        {# Normal day mode #}
                        var map = new google.maps.Map(
                            document.getElementById(map_parameters.identifier), {
                                zoom: map_parameters.zoom,
                                center: {lat: map_parameters.lat, lng: map_parameters.lng},
                                mapTypeId: map_parameters.mapType,
                                streetViewControl: map_parameters.streetview_control,
                                fullscreenControl: map_parameters.fullscreen_control,
                                mapTypeControlOptions: {
                                    mapTypeIds: ['terrain','night_map']
                                }
                            });

                        //Associate the night mode map with the MapTypeId and set it to display.
                        map.mapTypes.set('night_map', nightMapType);

                        //////////////////////////  Markers  ///////////////////

                        // Defines the icon parameters (circles)
                        function set_icon_parameters(color) {
                            var icon_parameters = {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 7,
                                fillOpacity: 0.8,
                                strokeOpacity: 0.8,
                                strokeWeight: 0.8
                            };
                            icon_parameters.fillColor = color;
                            {#icon_parameters.strokeColor: color,#}
                            return icon_parameters
                        }

                        // Creates the icons array.
                        const icons = {
                            police: {
                                name: 'Police Unit',
                                icon: set_icon_parameters('#484ed5')
                            },
                            ambulance: {
                                name: 'Ambulance',
                                icon: set_icon_parameters('#d51f13')
                            },
                            firefighter: {
                                name: 'Firefighter Unit',
                                icon: set_icon_parameters('#d57600')
                                }
                            };

                        // Create the markers array.
                        var dispatched_units = [];
                        for (i=0; i < map_parameters.units.length; i++) {
                            var unit = map_parameters.units[i];
                            dispatched_units.push({
                                position: new google.maps.LatLng(unit.lat, unit.lng),
                                type: unit.type,
                                name: unit.name,
                                content: '<div id="content"><div id="siteNotice"></div>'+
                                        '<h5 id="firstHeading" class="firstHeading">'+unit.name+'</h5>'+
                                        '<div id="bodyContent"><p><b>Unit ID: </b>'+unit.id+'</p>' +
                                        '<p>'+unit.infobox+'</p></div></div>'
                            });
                        }

                        var currentinfowindow = null; // To keep only one window open (see below in add listener)
                        var mouseover_on = false;

                        // Put the markers on the map.
                        dispatched_units.forEach(function(unit) {
                            var marker = new google.maps.Marker({
                                position: unit.position,
                                title: unit.name,
                                icon: icons[unit.type].icon,
                                map: map
                            });
                            var content = unit.content;
                            var infowindow = new google.maps.InfoWindow();
                            marker.addListener('click', (function() {
                                return function () {
                                    infowindow.setContent(content);
                                    if (currentinfowindow)
                                        currentinfowindow.close();
                                    infowindow.open(map, marker);
                                    currentinfowindow = infowindow;
                                };
                            })(marker, content, infowindow));

                            // To have the infowindow displayed during mouseover only. Nice now but might not be practical
                            // when the markers are moving!
                            if (mouseover_on) {
                                marker.addListener('mouseover', (function() {
                                return function () {
                                    infowindow.setContent(content);
                                    infowindow.open(map, marker);
                                };
                             })(marker, content, infowindow));

                            marker.addListener('mouseout', (function() {
                                return function () {
                                    infowindow.close();
                                };
                             })(infowindow));
                            }
                        });

                        //////////////////////////  Legend ///////////////////

                        // Create the legend
                        var legend = document.getElementById('legend');
                        for (var key in icons) {
                            var type = icons[key];
                            var name = type.name;
                            var color = type.icon.fillColor;
                            var div = document.createElement('div');
                            div.innerHTML = '<svg height="20" width="20"><circle cx="10" cy="10" r="7.5" stroke="black" stroke-width="1" fill="'+color+'"/></svg><b>' + name + '</b>';
                            legend.appendChild(div);
                        }

                        // Add the legend on the map
                        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend);

                        //////////////////////////  Djikstra Paths ///////////////////

                        for (var i=0;i < map_parameters.djikstra_path.length;i++) {
                            var path_information = map_parameters.djikstra_path[i];
                            var djikstraPath = new google.maps.Polyline({
                                path: path_information.coordinates,
                                geodesic: true,
                                strokeColor: icons[path_information.type].icon.fillColor,
                                strokeOpacity: 0.8,
                                strokeWeight: 3
                            });
                            djikstraPath.setMap(map);
                         }

                        //////////////////////////  Center on user  ///////////////////

                        // Allow the map to be centered on the user's location
                        if (map_parameters.center_on_user_location) {
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(function(position) {
                                    var pos = {
                                        lat: position.coords.latitude,
                                        lng: position.coords.longitude
                                    };
                                    map.setCenter(pos);
                                }, function() {
                                    handleLocationError(true, infoWindow, map.getCenter());
                                });
                            }
                            else {
                                // Browser doesn't support Geolocation
                                handleLocationError(false, infoWindow, map.getCenter());
                            }
                        }
                    }

                    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                        infoWindow.setPosition(pos);
                        infoWindow.setContent(browserHasGeolocation ?
                            'Error: The Geolocation service failed.' :
                            'Error: Your browser doesn\'t support geolocation.');
                        infoWindow.open(map);
                    }
                </script>
            </div>
            <div id="legend"><h5>Legend</h5></div>
            </div>
            <div class="col-lg-2 id="calls>
                <p> Some calls are displayed here. </p>
            </div>
        </div>

        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 border-bottom"></div>
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <p class="lead"><b>Here are some statistics about recent calls.</b></p>
        </div>
    </main>

{% endblock %}